# 云端存储使用指南

恭喜！云函数测试通过，现在可以使用云端存储功能了。

## ✅ 数据同步机制

### 存储策略

应用的存储策略是：**本地优先，云端同步**

1. **所有操作先保存到本地**
   - 确保数据不丢失
   - 支持离线使用
   - 响应速度快

2. **自动同步到云端**（如果配置了 API Key）
   - 异步同步，不阻塞主流程
   - 云端同步失败不影响本地数据
   - 支持多设备数据同步

## 🚀 如何使用

### 自动同步

配置好 API Key 后，数据会自动同步：

1. **创建任务**
   - 先保存到本地存储
   - 然后自动同步到云端

2. **更新任务**
   - 先更新本地存储
   - 然后自动同步到云端

3. **删除任务**
   - 先删除本地存储
   - 然后自动同步删除到云端

4. **获取任务**
   - 如果配置了 API Key，优先从云端获取
   - 云端失败时使用本地数据

### 手动同步

如果需要手动触发同步：

```typescript
import { taskService } from './services/task.service';

// 手动同步所有数据
await taskService.manualSync();
```

## 📋 检查云端存储状态

### 方法 1：查看存储类型

```typescript
import { taskService } from './services/task.service';

const storageType = taskService.getStorageType();
console.log('当前存储类型:', storageType); // 'cloud' 或 'local'
```

### 方法 2：检查 API Key 配置

```typescript
import { API_CONFIG } from './config/api.config';

console.log('API Key 已配置:', !!API_CONFIG.API_KEY);
console.log('API Key 前缀:', API_CONFIG.API_KEY ? API_CONFIG.API_KEY.substring(0, 8) + '...' : '未配置');
```

## 🔍 验证数据同步

### 1. 创建任务并查看日志

在浏览器控制台查看：

```javascript
// 创建任务后，应该看到：
// - 先保存到本地
// - 然后异步同步到云端（如果配置了 API Key）
```

### 2. 查看云函数日志

1. 登录 [腾讯云开发控制台](https://console.cloud.tencent.com/tcb)
2. 进入云函数 → `task-collection-api` → "日志"
3. 查看是否有创建任务的请求

### 3. 查看数据库

1. 在云开发控制台，进入"数据库"
2. 选择 `tasks` 集合
3. 查看是否有新创建的任务数据

## 📝 数据同步流程示例

### 创建任务流程

```
用户创建任务
    ↓
保存到本地存储 (AsyncStorage)
    ↓
检查是否配置了 API Key
    ↓
是 → 异步同步到云端 (不阻塞)
    ↓
返回任务数据给用户
```

### 获取任务流程

```
用户获取任务
    ↓
检查是否配置了 API Key
    ↓
是 → 尝试从云端获取
    ↓
成功 → 保存到本地并返回
失败 → 从本地获取并返回
```

## ⚠️ 注意事项

### 1. 本地存储优先

- 所有操作都先保存到本地
- 即使云端同步失败，本地数据也不会丢失
- 确保离线时也能正常使用

### 2. 异步同步

- 云端同步是异步的，不会阻塞用户操作
- 如果同步失败，会在控制台输出错误日志
- 可以稍后手动同步

### 3. 数据一致性

- 如果多设备同时使用，可能会有数据冲突
- 建议使用时间戳来判断最新数据
- 或者使用云端的 `updatedAt` 字段

### 4. API Key 配置

- 必须配置 `EXPO_PUBLIC_API_KEY` 才能使用云端存储
- 必须配置云函数环境变量 `API_KEY_1` 和 `TCB_ENV`
- 配置后需要重启开发服务器

## 🐛 故障排查

### 问题 1：数据没有同步到云端

**检查清单：**
- [ ] `.env` 文件中是否配置了 `EXPO_PUBLIC_API_KEY`
- [ ] 是否重启了开发服务器
- [ ] 云函数环境变量是否配置正确
- [ ] 查看浏览器控制台是否有错误

### 问题 2：云端同步失败

**可能原因：**
- 网络连接问题
- API Key 配置错误
- 云函数未正确部署

**解决方法：**
1. 检查网络连接
2. 验证 API Key 配置
3. 查看云函数日志
4. 使用 `/test-api` 页面测试

### 问题 3：数据不同步

**可能原因：**
- API Key 未配置
- 云函数环境变量未配置

**解决方法：**
1. 检查 `taskService.getStorageType()` 返回的值
2. 如果是 `'local'`，说明未配置 API Key
3. 配置 API Key 后重启服务器

## 📚 相关文档

- [API Key 设置指南](./API_KEY_SETUP.md)
- [环境变量配置指南](./ENV_VARIABLES_GUIDE.md)
- [腾讯云配置指南](./TENCENT_CLOUD_SETUP.md)
- [云函数部署指南](./CLOUD_FUNCTION_DEPLOY.md)

## ✅ 成功标志

云端存储正常工作后，你应该看到：

1. ✅ `taskService.getStorageType()` 返回 `'cloud'`
2. ✅ 创建任务后，云函数日志中有创建请求
3. ✅ 数据库中可以看到新创建的任务
4. ✅ 多设备可以同步数据

## 🎉 开始使用

现在你可以：

1. **创建任务** - 数据会自动保存到本地和云端
2. **查看任务** - 优先从云端获取最新数据
3. **更新任务** - 本地和云端都会更新
4. **删除任务** - 本地和云端都会删除
5. **多设备同步** - 在不同设备上查看相同的数据

享受云端存储带来的便利吧！🚀

