# 创建 users 数据库集合

## ❌ 错误信息

```
[ResourceNotFound] Db or Table not exist. Please check your request
```

这个错误表示云函数尝试访问 `users` 集合，但该集合在数据库中不存在。

## ✅ 解决方案

需要在云开发控制台创建 `users` 集合。

## 📋 创建步骤

### 步骤 1：登录云开发控制台

1. 访问 [腾讯云开发控制台](https://console.cloud.tencent.com/tcb)
2. 选择你的云开发环境

### 步骤 2：进入数据库

1. 在左侧菜单中，点击 **"数据库"**
2. 进入数据库管理页面

### 步骤 3：创建集合

1. 点击 **"新建集合"** 或 **"+"** 按钮
2. 输入集合名称：`users`
3. 点击 **"确定"** 或 **"创建"**

### 步骤 4：配置集合权限（可选）

创建集合后，建议配置权限：

1. 点击 `users` 集合
2. 进入 **"权限设置"** 标签
3. 选择权限模式：
   - **仅创建者可读写**（推荐）- 用户只能读写自己的数据
   - **所有用户可读，仅创建者可写** - 所有用户可读，但只能写自己的数据
   - **所有用户可读写** - 不推荐，安全性较低

### 步骤 5：创建索引（可选，提高查询性能）

为了提高手机号查询性能，建议创建索引：

1. 在 `users` 集合中，点击 **"索引"** 标签
2. 点击 **"新建索引"**
3. 配置索引：
   - **字段名：** `phone`
   - **排序：** `升序`
   - **唯一：** `是`（确保手机号唯一）
4. 点击 **"确定"**

## 🔍 验证集合是否创建成功

### 方法 1：在控制台查看

1. 进入数据库页面
2. 查看集合列表，应该能看到 `users` 集合

### 方法 2：通过云函数测试

创建集合后，再次尝试登录/注册，应该不会再出现这个错误。

## 📝 集合结构说明

`users` 集合将存储以下字段：

```javascript
{
  userId: "user_1234567890_abc123",  // 用户ID（唯一标识）
  phone: "13800138000",              // 手机号（唯一，用于登录）
  nickname: "用户昵称",                // 昵称
  membershipType: "free",            // 会员类型：free/monthly/yearly/lifetime
  membershipStatus: "active",        // 会员状态：active/expired/cancelled
  createdAt: "2025-01-01T00:00:00.000Z",  // 创建时间
  updatedAt: "2025-01-01T00:00:00.000Z",  // 更新时间
  // 扩展字段（可选）
  avatar: "头像URL",
  email: "邮箱",
  // ... 其他自定义字段
}
```

## ⚠️ 注意事项

1. **集合名称必须完全匹配**：确保集合名称是 `users`（小写，复数形式）
2. **权限设置**：建议使用"仅创建者可读写"，确保数据安全
3. **索引优化**：为 `phone` 字段创建唯一索引，提高查询性能
4. **数据备份**：定期备份数据库，防止数据丢失

## 🐛 如果仍然报错

### 检查 1：集合名称是否正确

确保云函数代码中使用的是 `users`：

```javascript
const usersCollection = db.collection('users');
```

### 检查 2：环境是否正确

确保云函数连接的是正确的云开发环境（`TCB_ENV` 环境变量配置正确）。

### 检查 3：权限是否正确

确保云函数有权限访问数据库：
- 检查云函数的服务角色权限
- 检查数据库的访问权限设置

### 检查 4：重新部署云函数

如果集合已创建但仍然报错，尝试：
1. 重新部署云函数
2. 清除云函数缓存
3. 重新测试

## ✅ 完成后的验证

创建集合后，执行以下操作验证：

1. **测试注册**：
   ```bash
   POST /auth/register
   {
     "phone": "13800138000",
     "nickname": "测试用户"
   }
   ```

2. **测试登录**：
   ```bash
   POST /auth/login
   {
     "phone": "13800138000"
   }
   ```

3. **查看数据**：
   - 在云开发控制台的数据库中
   - 进入 `users` 集合
   - 应该能看到新创建的用户数据

## 📚 相关文档

- [用户认证云函数完整代码](./USER_AUTH_CLOUD_FUNCTION_COMPLETE.md)
- [云函数部署指南](./CLOUD_FUNCTION_DEPLOY.md)
- [腾讯云配置指南](./TENCENT_CLOUD_SETUP.md)

完成以上步骤后，错误应该就会消失了！

