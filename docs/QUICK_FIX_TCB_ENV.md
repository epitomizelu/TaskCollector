# 🔧 快速修复：TCB_ENV 环境变量配置错误

## 问题症状

错误信息：
```
[100003] Param Invalid: env check invalid be filterd
```

这表示云函数环境变量 `TCB_ENV` 配置有问题。

## 🚀 快速解决方案

### 步骤 1：登录腾讯云控制台

1. 访问 [腾讯云开发控制台](https://console.cloud.tencent.com/tcb)
2. 登录你的账号

### 步骤 2：获取云开发环境 ID

1. 在云开发控制台首页，可以看到你的环境列表
2. 找到你使用的环境，查看**环境 ID**
3. 环境 ID 格式通常为：
   - `cloud1-xxxxx`（旧版）
   - `env-xxxxx`（新版）
   - 例如：`cloud1-4gee45pq61cd6f19`

**如何查看环境 ID：**

**方法 1：在控制台首页**
- 登录后，在首页的环境列表中可以看到环境 ID
- 点击环境名称，进入环境详情页

**方法 2：在云函数中查看**
- 进入云函数 → 任意函数 → "函数配置"
- 可以看到函数所属的环境 ID

**方法 3：在数据库集合中查看**
- 进入数据库 → 任意集合
- URL 中可以看到环境 ID

**方法 4：从云函数 URL 中提取**
- 查看你的云函数 URL：`https://cloud1-4gee45pq61cd6f19-1259499058.ap-shanghai.app.tcloudbase.com/...`
- 环境 ID 是 `cloud1-4gee45pq61cd6f19`（URL 中的第一部分）

### 步骤 3：配置云函数环境变量

1. 在云函数控制台，找到你的云函数：`task-collection-api`
2. 点击函数名称进入详情页
3. 点击"环境变量"标签
4. 检查是否存在 `TCB_ENV` 环境变量

**如果不存在或值不正确：**

1. 点击"新增环境变量"或"编辑"
2. 配置环境变量：
   - **变量名：** `TCB_ENV`
   - **变量值：** 你的实际环境 ID（例如：`cloud1-4gee45pq61cd6f19`）
   - **描述：** 云开发环境标识
3. 点击"保存"

**重要提示：**
- ✅ **必须使用正确的环境 ID**，不能使用 `'your-env-id'` 这样的占位符
- ✅ **不要包含引号**，直接填写环境 ID 值
- ✅ **不要有空格**，确保环境 ID 前后没有空格
- ✅ **区分大小写**，确保环境 ID 的大小写正确

### 步骤 4：验证配置

1. 在云函数控制台，查看"环境变量"列表
2. 确认看到：
   - ✅ `TCB_ENV` = `你的环境ID`（例如：`cloud1-4gee45pq61cd6f19`）
   - ✅ `API_KEY_1` = `你的API Key值`

**注意：** 环境变量的值会被隐藏显示（显示为 `****`），这是正常的安全措施。

### 步骤 5：等待生效并测试

1. 保存后等待 10-20 秒让配置生效
2. 访问前端测试页面 `/test-api`
3. 点击"开始测试"
4. 查看云函数日志，应该不再出现 `env check invalid` 错误

## 🔍 常见错误

### 错误 1：使用了占位符值

**错误配置：**
```
TCB_ENV = your-env-id
```

**正确配置：**
```
TCB_ENV = cloud1-4gee45pq61cd6f19
```

### 错误 2：环境 ID 格式错误

**错误配置：**
```
TCB_ENV = cloud1-4gee45pq61cd6f19-1259499058  # 包含了多余的标识
TCB_ENV = https://cloud1-4gee45pq61cd6f19...  # 包含了 URL
```

**正确配置：**
```
TCB_ENV = cloud1-4gee45pq61cd6f19  # 只有环境 ID
```

### 错误 3：环境 ID 不存在

**原因：** 使用了错误的环境 ID，或者环境已被删除。

**解决：**
1. 确认环境是否存在
2. 确认环境 ID 是否正确
3. 如果环境不存在，需要先创建环境

## 📝 完整配置示例

### 云函数环境变量配置

```
TCB_ENV = cloud1-4gee45pq61cd6f19
API_KEY_1 = a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

### 云函数代码中的使用

```javascript
const cloudbase = require('@cloudbase/node-sdk');

// 初始化云开发环境
const app = cloudbase.init({
  env: process.env.TCB_ENV || 'your-env-id',  // 如果 TCB_ENV 未配置，会使用默认值（无效）
});

// 获取数据库引用
const db = app.database();
```

**注意：** 如果 `process.env.TCB_ENV` 是 `undefined` 或 `'your-env-id'`，会导致错误。

## ✅ 验证步骤

### 1. 在云函数代码中添加调试日志

在云函数代码的开头添加：

```javascript
console.log('TCB_ENV 配置:', {
  tcbEnv: process.env.TCB_ENV,
  hasTcbEnv: !!process.env.TCB_ENV,
  tcbEnvType: typeof process.env.TCB_ENV,
});
```

然后查看云函数日志，确认：
- ✅ `tcbEnv` 显示正确的环境 ID（例如：`cloud1-4gee45pq61cd6f19`）
- ✅ `hasTcbEnv` 为 `true`
- ✅ `tcbEnvType` 为 `'string'`

### 2. 测试数据库连接

如果 `TCB_ENV` 配置正确，数据库操作应该可以正常执行。

### 3. 查看错误日志

如果仍然报错，查看云函数日志中的详细错误信息。

## 🐛 如果仍然有问题

### Q1: 找不到环境 ID

**解决：**
1. 确认你已经创建了云开发环境
2. 在云开发控制台首页查看环境列表
3. 如果环境不存在，需要先创建环境

### Q2: 环境 ID 格式不确定

**解决：**
- 旧版格式：`cloud1-xxxxx`
- 新版格式：`env-xxxxx`
- 两种格式都可以使用，只要确保是实际存在的环境 ID

### Q3: 配置后仍然报错

**解决：**
1. 确认环境变量已保存
2. 等待 10-20 秒让配置生效
3. 重新部署云函数（如果可能）
4. 检查环境变量值是否正确（没有多余的空格、引号等）

### Q4: 多个环境如何选择

**解决：**
- 如果你有多个环境（开发、测试、生产），为每个环境创建独立的云函数
- 或者使用不同的环境变量值来区分

## 📚 相关文档

- [云函数部署完整指南](./CLOUD_FUNCTION_DEPLOY.md)
- [快速修复 401 错误](./QUICK_FIX_401.md)
- [快速修复：服务器未配置 API Key](./QUICK_FIX_NO_API_KEY.md)

## ✅ 检查清单

修复后，确认以下各项：

- [ ] 已获取正确的云开发环境 ID
- [ ] 云函数环境变量 `TCB_ENV` 已配置
- [ ] `TCB_ENV` 的值是正确的环境 ID（不是占位符）
- [ ] 环境 ID 格式正确（没有多余字符）
- [ ] 已保存环境变量配置
- [ ] 等待配置生效（10-20 秒）
- [ ] 测试接口不再报错

## 💡 提示

如果环境 ID 不确定，可以：
1. 查看云函数 URL 中的环境 ID
2. 在云开发控制台首页查看环境列表
3. 在云函数代码中添加日志输出环境 ID

完成以上步骤后，`env check invalid` 错误应该可以解决！

