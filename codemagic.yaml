workflows:
  android-preview:
    name: Android Preview Build (APK)
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - taskColl
      # å¦‚æœéœ€è¦ç¯å¢ƒå˜é‡ç»„ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶æ·»åŠ ç»„å
      # groups:
      #   - your_group_name
      # æ³¨æ„: EXPO_PUBLIC_API_KEY éœ€è¦åœ¨ Codemagic UI ä¸­é…ç½®
      # è·¯å¾„: Settings > Environment variables > Add variable
      # å˜é‡å: EXPO_PUBLIC_API_KEY
      # å˜é‡å€¼: ä½ çš„å®é™… API Key
      # å‹¾é€‰ "Secure" é€‰é¡¹ä»¥åŠ å¯†å­˜å‚¨
      # vars éƒ¨åˆ†ç•™ç©ºï¼Œç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨ä» Codemagic UI è¯»å–
      vars: {}
      node: 20.18.0
      java: 17
    scripts:
      - name: Verify environment variables (early check)
        script: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo ""
            echo "âŒ æ„å»ºå¤±è´¥: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "   1. ç™»å½• Codemagic æ§åˆ¶å°"
            echo "   2. è¿›å…¥é¡¹ç›® Settings > Environment variables"
            echo "   3. æ·»åŠ å˜é‡: EXPO_PUBLIC_API_KEY = ä½ çš„å®é™… API Key"
            echo "   4. å‹¾é€‰ 'Secure' é€‰é¡¹ï¼ˆæ¨èï¼‰"
            echo "   5. ä¿å­˜å¹¶é‡æ–°è§¦å‘æ„å»º"
            echo ""
            echo "ğŸ’¡ æç¤º: ç¯å¢ƒå˜é‡æœªé…ç½®æ—¶ï¼Œæ„å»ºä¼šç«‹å³ä¸­æ–­ä»¥é¿å…æµªè´¹èµ„æº"
            exit 1
          fi
          # æ˜¾ç¤º API_KEY çš„å‰ç¼€å’Œåç¼€ï¼Œç”¨äºéªŒè¯æ˜¯å¦æ­£ç¡®è·å–
          API_KEY_LEN=${#EXPO_PUBLIC_API_KEY}
          API_KEY_PREFIX="${EXPO_PUBLIC_API_KEY:0:6}"
          API_KEY_SUFFIX="${EXPO_PUBLIC_API_KEY: -4}"
          echo "âœ… EXPO_PUBLIC_API_KEY å·²é…ç½®"
          echo "   é•¿åº¦: ${API_KEY_LEN} å­—ç¬¦"
          echo "   å‰ç¼€: ${API_KEY_PREFIX}..."
          echo "   åç¼€: ...${API_KEY_SUFFIX}"
          echo "ğŸš€ ç»§ç»­æ„å»ºæµç¨‹..."
      - name: Install dependencies
        script: |
          npm ci
      - name: Setup Expo
        script: |
          npx expo install --fix
      - name: Prebuild (if needed)
        script: |
          # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨ prebuild æ—¶å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          npx expo prebuild --platform android --clean || true
      - name: Build Android APK
        script: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease
      - name: Upload APK to Cloud Storage and Save Version Info
        script: |
          echo "=========================================="
          echo "  ä¸Šä¼  APK åˆ°äº‘å­˜å‚¨å¹¶ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯"
          echo "=========================================="
          echo ""
          
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo "âš ï¸  è­¦å‘Š: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo "   è·³è¿‡ä¸Šä¼ å’Œä¿å­˜ç‰ˆæœ¬ä¿¡æ¯"
            echo "   è¯·è®¾ç½®ç¯å¢ƒå˜é‡åé‡æ–°è¿è¡Œ"
            exit 0
          fi
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          VERSION=$(node -p "require('./app.json').expo.version")
          VERSION_CODE=$(node -p "require('./app.json').expo.android.versionCode")
          echo "ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯: v${VERSION} (Build ${VERSION_CODE})"
          
          # æŸ¥æ‰¾ APK æ–‡ä»¶
          APK_FILE=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° APK æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° APK æ–‡ä»¶: ${APK_FILE}"
          APK_SIZE=$(stat -f%z "$APK_FILE" 2>/dev/null || stat -c%s "$APK_FILE" 2>/dev/null || echo "0")
          if [ "$APK_SIZE" != "0" ]; then
            APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc 2>/dev/null || echo "N/A")
            echo "ğŸ“Š APK æ–‡ä»¶å¤§å°: ${APK_SIZE_MB} MB"
          fi
          
          echo ""
          echo "ğŸš€ å¼€å§‹ä¸Šä¼  APK åˆ°è…¾è®¯äº‘å­˜å‚¨..."
          echo "   è¿™å°†è‡ªåŠ¨è·å–ä¸‹è½½ URL å¹¶ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯åˆ°æ•°æ®åº“"
          echo ""
          
          # ä½¿ç”¨ upload-apk-to-tcb.js è„šæœ¬ä¸Šä¼  APK
          # è¯¥è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
          # 1. ä¸Šä¼  APK åˆ°è…¾è®¯äº‘å­˜å‚¨
          # 2. è·å–ä¸‹è½½ URL
          # 3. ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯åˆ°æ•°æ®åº“ï¼ˆå¼ºåˆ¶æ›´æ–°ï¼‰
          # è®¾ç½® FORCE_UPDATE=true ç¯å¢ƒå˜é‡ï¼Œä½¿è„šæœ¬ä¿å­˜åˆ°å¼ºåˆ¶æ›´æ–°é›†åˆ
          FORCE_UPDATE=true node scripts/upload-apk-to-tcb.js "${APK_FILE}" || {
            echo ""
            echo "âš ï¸  ä¸Šä¼ å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ..."
            echo ""
            
            # å¤‡ç”¨æ–¹æ¡ˆï¼šå°è¯•ä» Codemagic è·å– artifact URL
            DOWNLOAD_URL=""
            
            # æ–¹æ³•1: ä»ç¯å¢ƒå˜é‡ CM_ARTIFACT_LINKS è·å–
            if [ -n "$CM_ARTIFACT_LINKS" ]; then
              DOWNLOAD_URL=$(echo "$CM_ARTIFACT_LINKS" | grep -oE 'https://[^ ]+\.apk' | head -1)
              if [ -n "$DOWNLOAD_URL" ]; then
                echo "ğŸ“¥ ä»ç¯å¢ƒå˜é‡ CM_ARTIFACT_LINKS è·å–ä¸‹è½½ URL: ${DOWNLOAD_URL}"
              fi
            fi
            
            # æ–¹æ³•2: ä» Codemagic API è·å–ï¼ˆéœ€è¦ CM_API_TOKEN å’Œ CM_BUILD_IDï¼‰
            if [ -z "$DOWNLOAD_URL" ] && [ -n "$CM_API_TOKEN" ] && [ -n "$CM_BUILD_ID" ]; then
              echo "ğŸ“¥ å°è¯•ä» Codemagic API è·å–ä¸‹è½½ URL..."
              echo "   æ„å»ºID: ${CM_BUILD_ID}"
              
              API_RESPONSE=$(curl -s -H "Authorization: Bearer $CM_API_TOKEN" \
                "https://api.codemagic.io/builds/${CM_BUILD_ID}/artifacts" 2>/dev/null)
              
              if [ $? -eq 0 ] && [ -n "$API_RESPONSE" ]; then
                if command -v jq &> /dev/null; then
                  DOWNLOAD_URL=$(echo "$API_RESPONSE" | jq -r '.artifacts[] | select(.name | contains("apk") or contains("APK")) | .url' | head -1)
                  if [ -n "$DOWNLOAD_URL" ] && [ "$DOWNLOAD_URL" != "null" ]; then
                    echo "âœ… ä» Codemagic API è·å–åˆ°ä¸‹è½½ URL: ${DOWNLOAD_URL}"
                  fi
                else
                  DOWNLOAD_URL=$(echo "$API_RESPONSE" | grep -oE 'https://[^"]+\.apk' | head -1)
                  if [ -n "$DOWNLOAD_URL" ]; then
                    echo "âœ… ä» Codemagic API è·å–åˆ°ä¸‹è½½ URL: ${DOWNLOAD_URL}"
                  fi
                fi
              fi
            fi
            
            # å¦‚æœè·å–åˆ°äº† Codemagic çš„ä¸‹è½½ URLï¼Œä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
            if [ -n "$DOWNLOAD_URL" ]; then
              echo ""
              echo "ğŸ’¾ ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯åˆ°æ•°æ®åº“ï¼ˆä½¿ç”¨ Codemagic ä¸‹è½½ URLï¼‰..."
              node scripts/save-codemagic-apk-version.js "${DOWNLOAD_URL}" "" "${APK_FILE}" || {
                echo "âš ï¸  ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥"
                exit 1
              }
            else
              echo ""
              echo "âŒ æ— æ³•è·å–ä¸‹è½½ URL"
              echo "ğŸ’¡ æç¤º: æ„å»ºå®Œæˆåï¼Œè¯·ä» Codemagic æ§åˆ¶å°è·å–ä¸‹è½½ URLï¼Œç„¶åè¿è¡Œï¼š"
              echo "   node scripts/save-codemagic-apk-version.js <download-url> [apk-path]"
              echo ""
              echo "   æˆ–è€…æ‰‹åŠ¨ä¸Šä¼  APK åˆ°äº‘å­˜å‚¨ï¼š"
              echo "   node scripts/upload-apk-to-tcb.js <apk-path>"
              exit 1
            fi
          }
          
          echo ""
          echo "=========================================="
          echo "  âœ… APK ä¸Šä¼ å’Œç‰ˆæœ¬ä¿¡æ¯ä¿å­˜å®Œæˆ"
          echo "=========================================="
    artifacts:
      - android/app/build/outputs/apk/release/*.apk
    publishing:
      email:
        recipients:
          - epitomizelu@gmail.com
        notify:
          success: true
          failure: true

  android-production:
    name: Android Production Build (AAB)
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      # å¦‚æœéœ€è¦ç¯å¢ƒå˜é‡ç»„ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶æ·»åŠ ç»„å
      # groups:
      #   - your_group_name
      # æ³¨æ„: EXPO_PUBLIC_API_KEY éœ€è¦åœ¨ Codemagic UI ä¸­é…ç½®
      # è·¯å¾„: Settings > Environment variables > Add variable
      # å˜é‡å: EXPO_PUBLIC_API_KEY
      # å˜é‡å€¼: ä½ çš„å®é™… API Key
      # å‹¾é€‰ "Secure" é€‰é¡¹ä»¥åŠ å¯†å­˜å‚¨
      # vars éƒ¨åˆ†ç•™ç©ºï¼Œç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨ä» Codemagic UI è¯»å–
      vars: {}
      node: 20.18.0
      java: 17
    scripts:
      - name: Verify environment variables (early check)
        script: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo ""
            echo "âŒ æ„å»ºå¤±è´¥: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "   1. ç™»å½• Codemagic æ§åˆ¶å°"
            echo "   2. è¿›å…¥é¡¹ç›® Settings > Environment variables"
            echo "   3. æ·»åŠ å˜é‡: EXPO_PUBLIC_API_KEY = ä½ çš„å®é™… API Key"
            echo "   4. å‹¾é€‰ 'Secure' é€‰é¡¹ï¼ˆæ¨èï¼‰"
            echo "   5. ä¿å­˜å¹¶é‡æ–°è§¦å‘æ„å»º"
            echo ""
            echo "ğŸ’¡ æç¤º: ç¯å¢ƒå˜é‡æœªé…ç½®æ—¶ï¼Œæ„å»ºä¼šç«‹å³ä¸­æ–­ä»¥é¿å…æµªè´¹èµ„æº"
            exit 1
          fi
          # æ˜¾ç¤º API_KEY çš„å‰ç¼€å’Œåç¼€ï¼Œç”¨äºéªŒè¯æ˜¯å¦æ­£ç¡®è·å–
          API_KEY_LEN=${#EXPO_PUBLIC_API_KEY}
          API_KEY_PREFIX="${EXPO_PUBLIC_API_KEY:0:6}"
          API_KEY_SUFFIX="${EXPO_PUBLIC_API_KEY: -4}"
          echo "âœ… EXPO_PUBLIC_API_KEY å·²é…ç½®"
          echo "   é•¿åº¦: ${API_KEY_LEN} å­—ç¬¦"
          echo "   å‰ç¼€: ${API_KEY_PREFIX}..."
          echo "   åç¼€: ...${API_KEY_SUFFIX}"
          echo "ğŸš€ ç»§ç»­æ„å»ºæµç¨‹..."
      - name: Install dependencies
        script: |
          npm ci
      - name: Setup Expo
        script: |
          npx expo install --fix
      - name: Prebuild (if needed)
        script: |
          # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨ prebuild æ—¶å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          npx expo prebuild --platform android --clean || true
      - name: Build Android AAB
        script: |
          cd android
          chmod +x gradlew
          ./gradlew bundleRelease
    artifacts:
      - android/app/build/outputs/bundle/release/*.aab
    publishing:
      email:
        recipients:
          - epitomizelu@gmail.com # æ›¿æ¢ä¸ºä½ çš„é‚®ç®±
        notify:
          success: true
          failure: true

  # ğŸ†• ç‹¬ç«‹çš„ OTA æ›´æ–° workflowï¼ˆä»…æ„å»ºå’Œä¸Šä¼  JS Bundleï¼Œä¸æ„å»º APK/AABï¼‰
  ota-update-only:
    name: OTA Update Only (JS Bundle)
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      groups:
        - taskColl
      vars: {}
      node: 20.18.0
    scripts:
      - name: Verify environment variables
        script: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo ""
            echo "âŒ æ„å»ºå¤±è´¥: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "   1. ç™»å½• Codemagic æ§åˆ¶å°"
            echo "   2. è¿›å…¥é¡¹ç›® Settings > Environment variables"
            echo "   3. æ·»åŠ å˜é‡: EXPO_PUBLIC_API_KEY = ä½ çš„å®é™… API Key"
            echo "   4. å‹¾é€‰ 'Secure' é€‰é¡¹ï¼ˆæ¨èï¼‰"
            echo "   5. ä¿å­˜å¹¶é‡æ–°è§¦å‘æ„å»º"
            exit 1
          fi
          echo "âœ… EXPO_PUBLIC_API_KEY å·²é…ç½®"
      - name: Install dependencies
        script: |
          npm ci
      - name: Setup Expo
        script: |
          npx expo install --fix
      - name: Build and Upload JS Bundle
        script: |
          echo "=========================================="
          echo "  OTA æ›´æ–°ï¼šæ„å»ºå¹¶ä¸Šä¼  JS Bundle"
          echo "=========================================="
          echo ""
          # ç¡®ä¿ç¯å¢ƒå˜é‡å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          export NODE_ENV=production
          
          # æ„å»º JS Bundle
          echo "ğŸ“¦ æ­¥éª¤ 1/2: æ„å»º JS Bundle..."
          npm run build-js-bundle
          
          # ä¸Šä¼  JS Bundle
          echo ""
          echo "â˜ï¸  æ­¥éª¤ 2/2: ä¸Šä¼  JS Bundle åˆ°äº‘å­˜å‚¨..."
          npm run upload-js-bundle
          
          echo ""
          echo "=========================================="
          echo "  âœ… OTA æ›´æ–°åŒ…å·²æˆåŠŸä¸Šä¼ ï¼"
          echo "=========================================="
    publishing:
      email:
        recipients:
          - epitomizelu@gmail.com
        notify:
          success: true
          failure: true

