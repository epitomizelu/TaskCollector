workflows:
  android-preview:
    name: Android Preview Build (APK)
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - taskColl
      # å¦‚æœéœ€è¦ç¯å¢ƒå˜é‡ç»„ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶æ·»åŠ ç»„å
      # groups:
      #   - your_group_name
      # æ³¨æ„: EXPO_PUBLIC_API_KEY éœ€è¦åœ¨ Codemagic UI ä¸­é…ç½®
      # è·¯å¾„: Settings > Environment variables > Add variable
      # å˜é‡å: EXPO_PUBLIC_API_KEY
      # å˜é‡å€¼: ä½ çš„å®é™… API Key
      # å‹¾é€‰ "Secure" é€‰é¡¹ä»¥åŠ å¯†å­˜å‚¨
      # vars éƒ¨åˆ†ç•™ç©ºï¼Œç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨ä» Codemagic UI è¯»å–
      vars: {}
      node: 20.18.0
      java: 17
    scripts:
      - name: Verify environment variables (early check)
        script: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo ""
            echo "âŒ æ„å»ºå¤±è´¥: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "   1. ç™»å½• Codemagic æ§åˆ¶å°"
            echo "   2. è¿›å…¥é¡¹ç›® Settings > Environment variables"
            echo "   3. æ·»åŠ å˜é‡: EXPO_PUBLIC_API_KEY = ä½ çš„å®é™… API Key"
            echo "   4. å‹¾é€‰ 'Secure' é€‰é¡¹ï¼ˆæ¨èï¼‰"
            echo "   5. ä¿å­˜å¹¶é‡æ–°è§¦å‘æ„å»º"
            echo ""
            echo "ğŸ’¡ æç¤º: ç¯å¢ƒå˜é‡æœªé…ç½®æ—¶ï¼Œæ„å»ºä¼šç«‹å³ä¸­æ–­ä»¥é¿å…æµªè´¹èµ„æº"
            exit 1
          fi
          # æ˜¾ç¤º API_KEY çš„å‰ç¼€å’Œåç¼€ï¼Œç”¨äºéªŒè¯æ˜¯å¦æ­£ç¡®è·å–
          API_KEY_LEN=${#EXPO_PUBLIC_API_KEY}
          API_KEY_PREFIX="${EXPO_PUBLIC_API_KEY:0:6}"
          API_KEY_SUFFIX="${EXPO_PUBLIC_API_KEY: -4}"
          echo "âœ… EXPO_PUBLIC_API_KEY å·²é…ç½®"
          echo "   é•¿åº¦: ${API_KEY_LEN} å­—ç¬¦"
          echo "   å‰ç¼€: ${API_KEY_PREFIX}..."
          echo "   åç¼€: ...${API_KEY_SUFFIX}"
          echo "ğŸš€ ç»§ç»­æ„å»ºæµç¨‹..."
      - name: Install dependencies
        script: |
          npm ci
      - name: Setup Expo
        script: |
          npx expo install --fix
      - name: Prebuild (if needed)
        script: |
          # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨ prebuild æ—¶å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          npx expo prebuild --platform android --clean || true
      - name: Inject OTA Bundle Loader
        script: |
          echo "ğŸ”§ æ³¨å…¥ OTA Bundle Loader åˆ° MainApplication.kt..."
          echo "   æ”¯æŒæ–°æ¶æ„ (BridgelessReact)..."
          node scripts/inject-ota-bundle-loader.js
          echo ""
          echo "ğŸ“‹ éªŒè¯æ³¨å…¥ç»“æœ..."
          if grep -q "File(this@MainApplication.getFilesDir(), \"js-bundles\")" android/app/src/main/java/com/lcy/taskcollection/MainApplication.kt; then
            echo "âœ… ç¡®è®¤ï¼šMainApplication.kt åŒ…å« OTA å®ç°"
          else
            echo "âš ï¸  è­¦å‘Šï¼šMainApplication.kt å¯èƒ½ä¸åŒ…å« OTA å®ç°"
            echo "   æ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
            grep -A 10 "getJSBundleFile" android/app/src/main/java/com/lcy/taskcollection/MainApplication.kt || echo "   æœªæ‰¾åˆ° getJSBundleFile æ–¹æ³•"
          fi
      - name: Inject EAS Update Channel
        script: |
          # è®¾ç½®é»˜è®¤ channelï¼ˆé¢„è§ˆç‰ˆä½¿ç”¨ previewï¼‰
          export EAS_UPDATE_CHANNEL="${EAS_UPDATE_CHANNEL:-preview}"
          echo "ğŸ“¦ æ³¨å…¥ EAS Update Channel: $EAS_UPDATE_CHANNEL"
          node scripts/inject-eas-channel.js
          echo ""
          echo "ğŸ“‹ éªŒè¯ channel æ³¨å…¥ç»“æœ..."
          if grep -q "expo.modules.updates.EXPO_UPDATE_CHANNEL" android/app/src/main/AndroidManifest.xml; then
            echo "âœ… ç¡®è®¤ï¼šAndroidManifest.xml åŒ…å« EAS Update Channel"
            grep "expo.modules.updates.EXPO_UPDATE_CHANNEL" android/app/src/main/AndroidManifest.xml
          else
            echo "âš ï¸  è­¦å‘Šï¼šAndroidManifest.xml å¯èƒ½ä¸åŒ…å« EAS Update Channel"
          fi
      - name: Build Android APK
        script: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease
          echo ""
          echo "ğŸ“‹ æ„å»ºåéªŒè¯ MainApplication.kt..."
          if grep -q "File(this@MainApplication.getFilesDir(), \"js-bundles\")" app/src/main/java/com/lcy/taskcollection/MainApplication.kt; then
            echo "âœ… ç¡®è®¤ï¼šæ„å»ºå MainApplication.kt ä»åŒ…å« OTA å®ç°"
          else
            echo "âš ï¸  è­¦å‘Šï¼šæ„å»ºå MainApplication.kt å¯èƒ½ä¸åŒ…å« OTA å®ç°"
          fi
      - name: Get APK Download URL and Save to Database
        script: |
          echo "=========================================="
          echo "  è·å– APK ä¸‹è½½åœ°å€å¹¶ä¿å­˜åˆ°æ•°æ®åº“"
          echo "=========================================="
          echo ""
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          VERSION=$(node -p "require('./app.json').expo.version")
          VERSION_CODE=$(node -p "require('./app.json').expo.android.versionCode")
          echo "ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯: v${VERSION} (Build ${VERSION_CODE})"
          
          # æŸ¥æ‰¾ APK æ–‡ä»¶
          APK_FILE=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° APK æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° APK æ–‡ä»¶: ${APK_FILE}"
          
          # Codemagic æ„å»ºå®Œæˆåï¼ŒAPK ä¼šä½œä¸º artifact æä¾›ä¸‹è½½
          # æ³¨æ„ï¼šCodemagic çš„ artifact ä¸‹è½½ URL éœ€è¦é€šè¿‡ Codemagic API è·å–
          # æˆ–è€…ä»æ„å»ºå®Œæˆåçš„é€šçŸ¥ä¸­è·å–
          
          # å°è¯•ä»ç¯å¢ƒå˜é‡è·å–ä¸‹è½½ URLï¼ˆå¦‚æœ Codemagic æä¾›äº†ï¼‰
          DOWNLOAD_URL=""
          if [ -n "$CM_ARTIFACT_LINKS" ]; then
            DOWNLOAD_URL=$(echo "$CM_ARTIFACT_LINKS" | grep -oE 'https://[^ ]+\.apk' | head -1)
            echo "ğŸ“¥ ä»ç¯å¢ƒå˜é‡è·å–ä¸‹è½½ URL: ${DOWNLOAD_URL}"
          fi
          
          # å¦‚æœç¯å¢ƒå˜é‡ä¸­æ²¡æœ‰ï¼Œå°è¯•ä» Codemagic API è·å–
          # æ³¨æ„ï¼šéœ€è¦è®¾ç½® CM_API_TOKEN ç¯å¢ƒå˜é‡
          if [ -z "$DOWNLOAD_URL" ] && [ -n "$CM_API_TOKEN" ] && [ -n "$CM_BUILD_ID" ]; then
            echo "ğŸ“¥ å°è¯•ä» Codemagic API è·å–ä¸‹è½½ URL..."
            # è¿™é‡Œå¯ä»¥è°ƒç”¨ Codemagic API è·å– artifact ä¸‹è½½ URL
            # ç”±äº Codemagic API çš„å…·ä½“æ ¼å¼å¯èƒ½ä¸åŒï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªç¤ºä¾‹
            # DOWNLOAD_URL=$(curl -s -H "Authorization: Bearer $CM_API_TOKEN" \
            #   "https://api.codemagic.io/builds/$CM_BUILD_ID/artifacts" | \
            #   jq -r '.artifacts[] | select(.type=="apk") | .url' | head -1)
          fi
          
          # å¦‚æœä»ç„¶æ²¡æœ‰è·å–åˆ° URLï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨æä¾›
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "âš ï¸  è­¦å‘Š: æ— æ³•è‡ªåŠ¨è·å–ä¸‹è½½ URL"
            echo "ğŸ’¡ æç¤º: Codemagic æ„å»ºå®Œæˆåï¼ŒAPK ä¼šä½œä¸º artifact æä¾›ä¸‹è½½"
            echo "   è¯·ä» Codemagic æ§åˆ¶å°è·å–ä¸‹è½½ URLï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"
            echo "   node scripts/save-codemagic-apk-version.js <download-url> [apk-path]"
            echo ""
            echo "ğŸ“ æˆ–è€…ï¼Œå¦‚æœè®¾ç½®äº† CM_ARTIFACT_LINKS ç¯å¢ƒå˜é‡ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è·å–"
            exit 0
          fi
          
          # ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯åˆ°æ•°æ®åº“
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo "âš ï¸  è­¦å‘Š: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼Œè·³è¿‡ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯"
            echo "   è¯·è®¾ç½®ç¯å¢ƒå˜é‡åé‡æ–°è¿è¡Œï¼Œæˆ–æ‰‹åŠ¨è¿è¡Œï¼š"
            echo "   node scripts/save-codemagic-apk-version.js ${DOWNLOAD_URL} ${APK_FILE}"
          else
            echo ""
            echo "ğŸ’¾ ä¿å­˜å¼ºåˆ¶æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯åˆ°æ•°æ®åº“..."
            node scripts/save-codemagic-apk-version.js "${DOWNLOAD_URL}" "" "${APK_FILE}"
          fi
          
          echo ""
          echo "=========================================="
          echo "  âœ… APK ç‰ˆæœ¬ä¿¡æ¯å¤„ç†å®Œæˆ"
          echo "=========================================="
      - name: Build and Upload JS Bundle (OTA Update)
        script: |
          echo "=========================================="
          echo "  æ„å»ºå¹¶ä¸Šä¼  JS Bundle (OTA æ›´æ–°)"
          echo "=========================================="
          echo ""
          # ç¡®ä¿ç¯å¢ƒå˜é‡å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          export NODE_ENV=production
          
          # æ„å»º JS Bundle
          echo "ğŸ“¦ æ­¥éª¤ 1/2: æ„å»º JS Bundle..."
          npm run build-js-bundle
          
          # ä¸Šä¼  JS Bundle
          echo ""
          echo "â˜ï¸  æ­¥éª¤ 2/2: ä¸Šä¼  JS Bundle åˆ°äº‘å­˜å‚¨..."
          npm run upload-js-bundle
          
          echo ""
          echo "âœ… OTA æ›´æ–°åŒ…å·²æˆåŠŸä¸Šä¼ ï¼"
    artifacts:
      - android/app/build/outputs/apk/release/*.apk
    publishing:
      email:
        recipients:
          - epitomizelu@gmail.com
        notify:
          success: true
          failure: true

  android-production:
    name: Android Production Build (AAB)
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      # å¦‚æœéœ€è¦ç¯å¢ƒå˜é‡ç»„ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶æ·»åŠ ç»„å
      # groups:
      #   - your_group_name
      # æ³¨æ„: EXPO_PUBLIC_API_KEY éœ€è¦åœ¨ Codemagic UI ä¸­é…ç½®
      # è·¯å¾„: Settings > Environment variables > Add variable
      # å˜é‡å: EXPO_PUBLIC_API_KEY
      # å˜é‡å€¼: ä½ çš„å®é™… API Key
      # å‹¾é€‰ "Secure" é€‰é¡¹ä»¥åŠ å¯†å­˜å‚¨
      # vars éƒ¨åˆ†ç•™ç©ºï¼Œç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨ä» Codemagic UI è¯»å–
      vars: {}
      node: 20.18.0
      java: 17
    scripts:
      - name: Verify environment variables (early check)
        script: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo ""
            echo "âŒ æ„å»ºå¤±è´¥: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "   1. ç™»å½• Codemagic æ§åˆ¶å°"
            echo "   2. è¿›å…¥é¡¹ç›® Settings > Environment variables"
            echo "   3. æ·»åŠ å˜é‡: EXPO_PUBLIC_API_KEY = ä½ çš„å®é™… API Key"
            echo "   4. å‹¾é€‰ 'Secure' é€‰é¡¹ï¼ˆæ¨èï¼‰"
            echo "   5. ä¿å­˜å¹¶é‡æ–°è§¦å‘æ„å»º"
            echo ""
            echo "ğŸ’¡ æç¤º: ç¯å¢ƒå˜é‡æœªé…ç½®æ—¶ï¼Œæ„å»ºä¼šç«‹å³ä¸­æ–­ä»¥é¿å…æµªè´¹èµ„æº"
            exit 1
          fi
          # æ˜¾ç¤º API_KEY çš„å‰ç¼€å’Œåç¼€ï¼Œç”¨äºéªŒè¯æ˜¯å¦æ­£ç¡®è·å–
          API_KEY_LEN=${#EXPO_PUBLIC_API_KEY}
          API_KEY_PREFIX="${EXPO_PUBLIC_API_KEY:0:6}"
          API_KEY_SUFFIX="${EXPO_PUBLIC_API_KEY: -4}"
          echo "âœ… EXPO_PUBLIC_API_KEY å·²é…ç½®"
          echo "   é•¿åº¦: ${API_KEY_LEN} å­—ç¬¦"
          echo "   å‰ç¼€: ${API_KEY_PREFIX}..."
          echo "   åç¼€: ...${API_KEY_SUFFIX}"
          echo "ğŸš€ ç»§ç»­æ„å»ºæµç¨‹..."
      - name: Install dependencies
        script: |
          npm ci
      - name: Setup Expo
        script: |
          npx expo install --fix
      - name: Prebuild (if needed)
        script: |
          # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨ prebuild æ—¶å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          npx expo prebuild --platform android --clean || true
      - name: Inject OTA Bundle Loader
        script: |
          echo "ğŸ”§ æ³¨å…¥ OTA Bundle Loader åˆ° MainApplication.kt..."
          echo "   æ”¯æŒæ–°æ¶æ„ (BridgelessReact)..."
          node scripts/inject-ota-bundle-loader.js
          echo ""
          echo "ğŸ“‹ éªŒè¯æ³¨å…¥ç»“æœ..."
          if grep -q "File(this@MainApplication.getFilesDir(), \"js-bundles\")" android/app/src/main/java/com/lcy/taskcollection/MainApplication.kt; then
            echo "âœ… ç¡®è®¤ï¼šMainApplication.kt åŒ…å« OTA å®ç°"
          else
            echo "âš ï¸  è­¦å‘Šï¼šMainApplication.kt å¯èƒ½ä¸åŒ…å« OTA å®ç°"
            echo "   æ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
            grep -A 10 "getJSBundleFile" android/app/src/main/java/com/lcy/taskcollection/MainApplication.kt || echo "   æœªæ‰¾åˆ° getJSBundleFile æ–¹æ³•"
          fi
      - name: Inject EAS Update Channel
        script: |
          # è®¾ç½®é»˜è®¤ channelï¼ˆç”Ÿäº§ç‰ˆä½¿ç”¨ productionï¼‰
          export EAS_UPDATE_CHANNEL="${EAS_UPDATE_CHANNEL:-production}"
          echo "ğŸ“¦ æ³¨å…¥ EAS Update Channel: $EAS_UPDATE_CHANNEL"
          node scripts/inject-eas-channel.js
          echo ""
          echo "ğŸ“‹ éªŒè¯ channel æ³¨å…¥ç»“æœ..."
          if grep -q "expo.modules.updates.EXPO_UPDATE_CHANNEL" android/app/src/main/AndroidManifest.xml; then
            echo "âœ… ç¡®è®¤ï¼šAndroidManifest.xml åŒ…å« EAS Update Channel"
            grep "expo.modules.updates.EXPO_UPDATE_CHANNEL" android/app/src/main/AndroidManifest.xml
          else
            echo "âš ï¸  è­¦å‘Šï¼šAndroidManifest.xml å¯èƒ½ä¸åŒ…å« EAS Update Channel"
          fi
      - name: Build Android AAB
        script: |
          cd android
          chmod +x gradlew
          ./gradlew bundleRelease
          echo ""
          echo "ğŸ“‹ æ„å»ºåéªŒè¯ MainApplication.kt..."
          if grep -q "File(this@MainApplication.getFilesDir(), \"js-bundles\")" app/src/main/java/com/lcy/taskcollection/MainApplication.kt; then
            echo "âœ… ç¡®è®¤ï¼šæ„å»ºå MainApplication.kt ä»åŒ…å« OTA å®ç°"
          else
            echo "âš ï¸  è­¦å‘Šï¼šæ„å»ºå MainApplication.kt å¯èƒ½ä¸åŒ…å« OTA å®ç°"
          fi
      - name: Build and Upload JS Bundle (OTA Update)
        script: |
          echo "=========================================="
          echo "  æ„å»ºå¹¶ä¸Šä¼  JS Bundle (OTA æ›´æ–°)"
          echo "=========================================="
          echo ""
          # ç¡®ä¿ç¯å¢ƒå˜é‡å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          export NODE_ENV=production
          
          # æ„å»º JS Bundle
          echo "ğŸ“¦ æ­¥éª¤ 1/2: æ„å»º JS Bundle..."
          npm run build-js-bundle
          
          # ä¸Šä¼  JS Bundle
          echo ""
          echo "â˜ï¸  æ­¥éª¤ 2/2: ä¸Šä¼  JS Bundle åˆ°äº‘å­˜å‚¨..."
          npm run upload-js-bundle
          
          echo ""
          echo "âœ… OTA æ›´æ–°åŒ…å·²æˆåŠŸä¸Šä¼ ï¼"
    artifacts:
      - android/app/build/outputs/bundle/release/*.aab
    publishing:
      email:
        recipients:
          - epitomizelu@gmail.com # æ›¿æ¢ä¸ºä½ çš„é‚®ç®±
        notify:
          success: true
          failure: true

  # ğŸ†• ç‹¬ç«‹çš„ OTA æ›´æ–° workflowï¼ˆä»…æ„å»ºå’Œä¸Šä¼  JS Bundleï¼Œä¸æ„å»º APK/AABï¼‰
  ota-update-only:
    name: OTA Update Only (JS Bundle)
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      groups:
        - taskColl
      vars: {}
      node: 20.18.0
    scripts:
      - name: Verify environment variables
        script: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo ""
            echo "âŒ æ„å»ºå¤±è´¥: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "   1. ç™»å½• Codemagic æ§åˆ¶å°"
            echo "   2. è¿›å…¥é¡¹ç›® Settings > Environment variables"
            echo "   3. æ·»åŠ å˜é‡: EXPO_PUBLIC_API_KEY = ä½ çš„å®é™… API Key"
            echo "   4. å‹¾é€‰ 'Secure' é€‰é¡¹ï¼ˆæ¨èï¼‰"
            echo "   5. ä¿å­˜å¹¶é‡æ–°è§¦å‘æ„å»º"
            exit 1
          fi
          echo "âœ… EXPO_PUBLIC_API_KEY å·²é…ç½®"
      - name: Install dependencies
        script: |
          npm ci
      - name: Setup Expo
        script: |
          npx expo install --fix
      - name: Build and Upload JS Bundle
        script: |
          echo "=========================================="
          echo "  OTA æ›´æ–°ï¼šæ„å»ºå¹¶ä¸Šä¼  JS Bundle"
          echo "=========================================="
          echo ""
          # ç¡®ä¿ç¯å¢ƒå˜é‡å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          export NODE_ENV=production
          
          # æ„å»º JS Bundle
          echo "ğŸ“¦ æ­¥éª¤ 1/2: æ„å»º JS Bundle..."
          npm run build-js-bundle
          
          # ä¸Šä¼  JS Bundle
          echo ""
          echo "â˜ï¸  æ­¥éª¤ 2/2: ä¸Šä¼  JS Bundle åˆ°äº‘å­˜å‚¨..."
          npm run upload-js-bundle
          
          echo ""
          echo "=========================================="
          echo "  âœ… OTA æ›´æ–°åŒ…å·²æˆåŠŸä¸Šä¼ ï¼"
          echo "=========================================="
    publishing:
      email:
        recipients:
          - epitomizelu@gmail.com
        notify:
          success: true
          failure: true

