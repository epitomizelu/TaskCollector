workflows:
  android-preview:
    name: Android Preview Build (APK)
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - taskColl
      # å¦‚æœéœ€è¦ç¯å¢ƒå˜é‡ç»„ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶æ·»åŠ ç»„å
      # groups:
      #   - your_group_name
      # æ³¨æ„: EXPO_PUBLIC_API_KEY éœ€è¦åœ¨ Codemagic UI ä¸­é…ç½®
      # è·¯å¾„: Settings > Environment variables > Add variable
      # å˜é‡å: EXPO_PUBLIC_API_KEY
      # å˜é‡å€¼: ä½ çš„å®é™… API Key
      # å‹¾é€‰ "Secure" é€‰é¡¹ä»¥åŠ å¯†å­˜å‚¨
      # vars éƒ¨åˆ†ç•™ç©ºï¼Œç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨ä» Codemagic UI è¯»å–
      vars: {}
      node: 20.18.0
      java: 17
    scripts:
      - name: Verify environment variables (early check)
        script: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo ""
            echo "âŒ æ„å»ºå¤±è´¥: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "   1. ç™»å½• Codemagic æ§åˆ¶å°"
            echo "   2. è¿›å…¥é¡¹ç›® Settings > Environment variables"
            echo "   3. æ·»åŠ å˜é‡: EXPO_PUBLIC_API_KEY = ä½ çš„å®é™… API Key"
            echo "   4. å‹¾é€‰ 'Secure' é€‰é¡¹ï¼ˆæ¨èï¼‰"
            echo "   5. ä¿å­˜å¹¶é‡æ–°è§¦å‘æ„å»º"
            echo ""
            echo "ğŸ’¡ æç¤º: ç¯å¢ƒå˜é‡æœªé…ç½®æ—¶ï¼Œæ„å»ºä¼šç«‹å³ä¸­æ–­ä»¥é¿å…æµªè´¹èµ„æº"
            exit 1
          fi
          # æ˜¾ç¤º API_KEY çš„å‰ç¼€å’Œåç¼€ï¼Œç”¨äºéªŒè¯æ˜¯å¦æ­£ç¡®è·å–
          API_KEY_LEN=${#EXPO_PUBLIC_API_KEY}
          API_KEY_PREFIX="${EXPO_PUBLIC_API_KEY:0:6}"
          API_KEY_SUFFIX="${EXPO_PUBLIC_API_KEY: -4}"
          echo "âœ… EXPO_PUBLIC_API_KEY å·²é…ç½®"
          echo "   é•¿åº¦: ${API_KEY_LEN} å­—ç¬¦"
          echo "   å‰ç¼€: ${API_KEY_PREFIX}..."
          echo "   åç¼€: ...${API_KEY_SUFFIX}"
          echo "ğŸš€ ç»§ç»­æ„å»ºæµç¨‹..."
      - name: Install dependencies
        script: |
          npm ci
      - name: Setup Expo
        script: |
          npx expo install --fix
      - name: Prebuild (if needed)
        script: |
          # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨ prebuild æ—¶å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          npx expo prebuild --platform android --clean || true
      - name: Inject OTA Bundle Loader
        script: |
          echo "ğŸ”§ æ³¨å…¥ OTA Bundle Loader åˆ° MainApplication.kt..."
          node scripts/inject-ota-bundle-loader.js
      - name: Build Android APK
        script: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease
      - name: Build and Upload JS Bundle (OTA Update)
        script: |
          echo "=========================================="
          echo "  æ„å»ºå¹¶ä¸Šä¼  JS Bundle (OTA æ›´æ–°)"
          echo "=========================================="
          echo ""
          # ç¡®ä¿ç¯å¢ƒå˜é‡å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          export NODE_ENV=production
          
          # æ„å»º JS Bundle
          echo "ğŸ“¦ æ­¥éª¤ 1/2: æ„å»º JS Bundle..."
          npm run build-js-bundle
          
          # ä¸Šä¼  JS Bundle
          echo ""
          echo "â˜ï¸  æ­¥éª¤ 2/2: ä¸Šä¼  JS Bundle åˆ°äº‘å­˜å‚¨..."
          npm run upload-js-bundle
          
          echo ""
          echo "âœ… OTA æ›´æ–°åŒ…å·²æˆåŠŸä¸Šä¼ ï¼"
    artifacts:
      - android/app/build/outputs/apk/release/*.apk
    publishing:
      email:
        recipients:
          - epitomizelu@gmail.com
        notify:
          success: true
          failure: true

  android-production:
    name: Android Production Build (AAB)
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      # å¦‚æœéœ€è¦ç¯å¢ƒå˜é‡ç»„ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶æ·»åŠ ç»„å
      # groups:
      #   - your_group_name
      # æ³¨æ„: EXPO_PUBLIC_API_KEY éœ€è¦åœ¨ Codemagic UI ä¸­é…ç½®
      # è·¯å¾„: Settings > Environment variables > Add variable
      # å˜é‡å: EXPO_PUBLIC_API_KEY
      # å˜é‡å€¼: ä½ çš„å®é™… API Key
      # å‹¾é€‰ "Secure" é€‰é¡¹ä»¥åŠ å¯†å­˜å‚¨
      # vars éƒ¨åˆ†ç•™ç©ºï¼Œç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨ä» Codemagic UI è¯»å–
      vars: {}
      node: 20.18.0
      java: 17
    scripts:
      - name: Verify environment variables (early check)
        script: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo ""
            echo "âŒ æ„å»ºå¤±è´¥: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "   1. ç™»å½• Codemagic æ§åˆ¶å°"
            echo "   2. è¿›å…¥é¡¹ç›® Settings > Environment variables"
            echo "   3. æ·»åŠ å˜é‡: EXPO_PUBLIC_API_KEY = ä½ çš„å®é™… API Key"
            echo "   4. å‹¾é€‰ 'Secure' é€‰é¡¹ï¼ˆæ¨èï¼‰"
            echo "   5. ä¿å­˜å¹¶é‡æ–°è§¦å‘æ„å»º"
            echo ""
            echo "ğŸ’¡ æç¤º: ç¯å¢ƒå˜é‡æœªé…ç½®æ—¶ï¼Œæ„å»ºä¼šç«‹å³ä¸­æ–­ä»¥é¿å…æµªè´¹èµ„æº"
            exit 1
          fi
          # æ˜¾ç¤º API_KEY çš„å‰ç¼€å’Œåç¼€ï¼Œç”¨äºéªŒè¯æ˜¯å¦æ­£ç¡®è·å–
          API_KEY_LEN=${#EXPO_PUBLIC_API_KEY}
          API_KEY_PREFIX="${EXPO_PUBLIC_API_KEY:0:6}"
          API_KEY_SUFFIX="${EXPO_PUBLIC_API_KEY: -4}"
          echo "âœ… EXPO_PUBLIC_API_KEY å·²é…ç½®"
          echo "   é•¿åº¦: ${API_KEY_LEN} å­—ç¬¦"
          echo "   å‰ç¼€: ${API_KEY_PREFIX}..."
          echo "   åç¼€: ...${API_KEY_SUFFIX}"
          echo "ğŸš€ ç»§ç»­æ„å»ºæµç¨‹..."
      - name: Install dependencies
        script: |
          npm ci
      - name: Setup Expo
        script: |
          npx expo install --fix
      - name: Prebuild (if needed)
        script: |
          # ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨ prebuild æ—¶å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          npx expo prebuild --platform android --clean || true
      - name: Inject OTA Bundle Loader
        script: |
          echo "ğŸ”§ æ³¨å…¥ OTA Bundle Loader åˆ° MainApplication.kt..."
          node scripts/inject-ota-bundle-loader.js
      - name: Build Android AAB
        script: |
          cd android
          chmod +x gradlew
          ./gradlew bundleRelease
      - name: Build and Upload JS Bundle (OTA Update)
        script: |
          echo "=========================================="
          echo "  æ„å»ºå¹¶ä¸Šä¼  JS Bundle (OTA æ›´æ–°)"
          echo "=========================================="
          echo ""
          # ç¡®ä¿ç¯å¢ƒå˜é‡å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          export NODE_ENV=production
          
          # æ„å»º JS Bundle
          echo "ğŸ“¦ æ­¥éª¤ 1/2: æ„å»º JS Bundle..."
          npm run build-js-bundle
          
          # ä¸Šä¼  JS Bundle
          echo ""
          echo "â˜ï¸  æ­¥éª¤ 2/2: ä¸Šä¼  JS Bundle åˆ°äº‘å­˜å‚¨..."
          npm run upload-js-bundle
          
          echo ""
          echo "âœ… OTA æ›´æ–°åŒ…å·²æˆåŠŸä¸Šä¼ ï¼"
    artifacts:
      - android/app/build/outputs/bundle/release/*.aab
    publishing:
      email:
        recipients:
          - epitomizelu@gmail.com # æ›¿æ¢ä¸ºä½ çš„é‚®ç®±
        notify:
          success: true
          failure: true

  # ğŸ†• ç‹¬ç«‹çš„ OTA æ›´æ–° workflowï¼ˆä»…æ„å»ºå’Œä¸Šä¼  JS Bundleï¼Œä¸æ„å»º APK/AABï¼‰
  ota-update-only:
    name: OTA Update Only (JS Bundle)
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      groups:
        - taskColl
      vars: {}
      node: 20.18.0
    scripts:
      - name: Verify environment variables
        script: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
          if [ -z "$EXPO_PUBLIC_API_KEY" ]; then
            echo ""
            echo "âŒ æ„å»ºå¤±è´¥: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo ""
            echo "ğŸ“ é…ç½®æ­¥éª¤:"
            echo "   1. ç™»å½• Codemagic æ§åˆ¶å°"
            echo "   2. è¿›å…¥é¡¹ç›® Settings > Environment variables"
            echo "   3. æ·»åŠ å˜é‡: EXPO_PUBLIC_API_KEY = ä½ çš„å®é™… API Key"
            echo "   4. å‹¾é€‰ 'Secure' é€‰é¡¹ï¼ˆæ¨èï¼‰"
            echo "   5. ä¿å­˜å¹¶é‡æ–°è§¦å‘æ„å»º"
            exit 1
          fi
          echo "âœ… EXPO_PUBLIC_API_KEY å·²é…ç½®"
      - name: Install dependencies
        script: |
          npm ci
      - name: Setup Expo
        script: |
          npx expo install --fix
      - name: Build and Upload JS Bundle
        script: |
          echo "=========================================="
          echo "  OTA æ›´æ–°ï¼šæ„å»ºå¹¶ä¸Šä¼  JS Bundle"
          echo "=========================================="
          echo ""
          # ç¡®ä¿ç¯å¢ƒå˜é‡å¯ç”¨
          export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
          export NODE_ENV=production
          
          # æ„å»º JS Bundle
          echo "ğŸ“¦ æ­¥éª¤ 1/2: æ„å»º JS Bundle..."
          npm run build-js-bundle
          
          # ä¸Šä¼  JS Bundle
          echo ""
          echo "â˜ï¸  æ­¥éª¤ 2/2: ä¸Šä¼  JS Bundle åˆ°äº‘å­˜å‚¨..."
          npm run upload-js-bundle
          
          echo ""
          echo "=========================================="
          echo "  âœ… OTA æ›´æ–°åŒ…å·²æˆåŠŸä¸Šä¼ ï¼"
          echo "=========================================="
    publishing:
      email:
        recipients:
          - epitomizelu@gmail.com
        notify:
          success: true
          failure: true

