name: EAS Build Android Preview

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (Cache Disabled - Fix 408 Timeout)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # cache: 'npm'  # 临时禁用，避免 GitHub 缓存服务 408 错误

      - name: Install dependencies
        run: npm ci  # 更快安装，无缓存依赖

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          # expo-cache: false  # 禁用 Expo CLI 缓存（可选）

      - name: Run EAS Build with Retry
        env:
          # 从 GitHub Secrets 读取 API Key，EAS Build 会自动将其编译到 APK 中
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
        id: build
        run: |
          # 重试逻辑：如果 408 超时，自动重跑
          for i in {1..3}; do
            BUILD_OUTPUT=$(eas build --platform android --profile preview --non-interactive 2>&1)
            BUILD_EXIT_CODE=$?
            echo "$BUILD_OUTPUT"
            
            if [ $BUILD_EXIT_CODE -eq 0 ]; then
              # 提取下载 URL（使用更兼容的方式）
              DOWNLOAD_URL=$(echo "$BUILD_OUTPUT" | grep -oE 'https://expo.dev/artifacts/eas/[a-zA-Z0-9]+\.apk' | head -1)
              if [ -n "$DOWNLOAD_URL" ]; then
                echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
                echo "APK 下载地址: $DOWNLOAD_URL"
              else
                # 备用方法：从构建输出中查找包含 .apk 的行
                DOWNLOAD_URL=$(echo "$BUILD_OUTPUT" | grep '\.apk' | grep -oE 'https://[^ ]+' | head -1)
                if [ -n "$DOWNLOAD_URL" ]; then
                  echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
                  echo "APK 下载地址（备用方法）: $DOWNLOAD_URL"
                fi
              fi
              break
            fi
            echo "Build $i failed, retrying in 30s..."
            sleep 30
          done

      - name: Download APK
        if: success() && steps.build.outputs.download_url != ''
        run: |
          echo "开始下载 APK..."
          DOWNLOAD_URL="${{ steps.build.outputs.download_url }}"
          echo "下载地址: $DOWNLOAD_URL"
          curl -L -o ./app-release.apk "$DOWNLOAD_URL" || wget -O ./app-release.apk "$DOWNLOAD_URL"
          
          if [ -f "./app-release.apk" ]; then
            echo "✅ APK 下载成功"
            ls -lh ./app-release.apk
          else
            echo "❌ APK 下载失败"
            exit 1
          fi

      - name: Get Version Info
        if: success()
        id: version
        run: |
          VERSION=$(node -p "require('./app.json').expo.version")
          VERSION_CODE=$(node -p "require('./app.json').expo.android.versionCode")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "版本: v$VERSION (Build $VERSION_CODE)"

      - name: Upload APK to TCB Storage
        if: success() && steps.build.outputs.download_url != ''
        env:
          API_BASE_URL: https://cloud1-4gee45pq61cd6f19-1259499058.ap-shanghai.app.tcloudbase.com/task-collection-api
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
          EAS_DOWNLOAD_URL: ${{ steps.build.outputs.download_url }}
        run: |
          if [ -f "./app-release.apk" ]; then
            echo "开始上传 APK 到腾讯云存储..."
            echo "EAS 下载地址: $EAS_DOWNLOAD_URL"
            node scripts/upload-apk-to-tcb.js ./app-release.apk "$EAS_DOWNLOAD_URL"
          else
            echo "❌ APK 文件不存在，无法上传"
            exit 1
          fi

      - name: Upload Build Artifact (If Success)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-app
          path: |
            *.aab
            *.apk
          retention-days: 7