name: EAS Build Android Preview

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (Cache Disabled - Fix 408 Timeout)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # cache: 'npm'  # 临时禁用，避免 GitHub 缓存服务 408 错误

      - name: Install dependencies
        run: npm ci  # 更快安装，无缓存依赖

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          # expo-cache: false  # 禁用 Expo CLI 缓存（可选）

      - name: Run EAS Build with Retry
        run: |
          # 重试逻辑：如果 408 超时，自动重跑
          for i in {1..3}; do
            if eas build --platform android --profile preview --non-interactive; then
              break
            fi
            echo "Build $i failed, retrying in 30s..."
            sleep 30
          done

      - name: Upload Build Artifact (If Success)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-app
          path: |
            *.aab
            *.apk
          retention-days: 7