name: EAS Build Android Preview

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (Cache Disabled - Fix 408 Timeout)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # cache: 'npm'  # 临时禁用，避免 GitHub 缓存服务 408 错误

      - name: Install dependencies
        run: npm ci  # 更快安装，无缓存依赖

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          # expo-cache: false  # 禁用 Expo CLI 缓存（可选）

      - name: Run EAS Build with Retry
        env:
          # 从 GitHub Secrets 读取 API Key，EAS Build 会自动将其编译到 APK 中
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
        run: |
          # 重试逻辑：如果 408 超时，自动重跑
          for i in {1..3}; do
            if eas build --platform android --profile preview --non-interactive; then
              break
            fi
            echo "Build $i failed, retrying in 30s..."
            sleep 30
          done

      - name: Download APK
        if: success()
        run: |
          echo "等待构建完成..."
          sleep 10
          eas build:download --platform android --latest --output ./app-release.apk || echo "下载失败，将在后续步骤重试"

      - name: Get Version Info
        if: success()
        id: version
        run: |
          VERSION=$(node -p "require('./app.json').expo.version")
          VERSION_CODE=$(node -p "require('./app.json').expo.android.versionCode")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "版本: v$VERSION (Build $VERSION_CODE)"

      - name: Upload APK to TCB Storage
        if: success()
        env:
          API_BASE_URL: https://cloud1-4gee45pq61cd6f19-1259499058.ap-shanghai.app.tcloudbase.com/task-collection-api
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
        run: |
          if [ -f "./app-release.apk" ]; then
            echo "开始上传 APK 到腾讯云存储..."
            node scripts/upload-apk-to-tcb.js ./app-release.apk
          else
            echo "APK 文件不存在，尝试重新下载..."
            eas build:download --platform android --latest --output ./app-release.apk
            if [ -f "./app-release.apk" ]; then
              node scripts/upload-apk-to-tcb.js ./app-release.apk
            else
              echo "警告: 无法下载 APK，请手动上传"
            fi
          fi

      - name: Upload Build Artifact (If Success)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-app
          path: |
            *.aab
            *.apk
          retention-days: 7