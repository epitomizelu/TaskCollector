name: Test Download and Upload APK

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      download_url:
        description: 'APK ä¸‹è½½ URLï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›ä¼šå°è¯•ä»æœ€æ–°æ„å»ºè·å–ï¼‰'
        required: false
        type: string

jobs:
  test-download-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Get Latest Build URL (if not provided)
        if: ${{ github.event.inputs.download_url == '' }}
        id: get_build_url
        run: |
          echo "è·å–æœ€æ–°çš„æ„å»ºä¿¡æ¯..."
          BUILD_LIST=$(eas build:list --platform android --limit 1 --json --non-interactive || echo "[]")
          
          # ä½¿ç”¨ Node.js è§£æ JSON
          DOWNLOAD_URL=$(node -e "
            const builds = JSON.parse(process.argv[1]);
            if (builds && builds.length > 0 && builds[0].artifacts && builds[0].artifacts.buildUrl) {
              console.log(builds[0].artifacts.buildUrl);
            }
          " "$BUILD_LIST" || echo "")
          
          if [ -n "$DOWNLOAD_URL" ]; then
            echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
            echo "æ‰¾åˆ°ä¸‹è½½ URL: $DOWNLOAD_URL"
          else
            echo "æœªæ‰¾åˆ°ä¸‹è½½ URL"
            exit 1
          fi

      - name: Set Download URL
        id: set_url
        run: |
          if [ -n "${{ github.event.inputs.download_url }}" ]; then
            echo "download_url=${{ github.event.inputs.download_url }}" >> $GITHUB_OUTPUT
            echo "ä½¿ç”¨æä¾›çš„ URL: ${{ github.event.inputs.download_url }}"
          else
            echo "download_url=${{ steps.get_build_url.outputs.download_url }}" >> $GITHUB_OUTPUT
            echo "ä½¿ç”¨è·å–çš„ URL: ${{ steps.get_build_url.outputs.download_url }}"
          fi

      - name: Download APK
        run: |
          DOWNLOAD_URL="${{ steps.set_url.outputs.download_url }}"
          echo "ğŸ“¥ ä¸‹è½½ URL: $DOWNLOAD_URL"
          echo "å¼€å§‹ä¸‹è½½ APK..."
          
          curl -L -o ./test-app-release.apk "$DOWNLOAD_URL" || wget -O ./test-app-release.apk "$DOWNLOAD_URL"
          
          if [ -f "./test-app-release.apk" ]; then
            echo "âœ… APK ä¸‹è½½æˆåŠŸ"
            ls -lh ./test-app-release.apk
          else
            echo "âŒ APK ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: Get Version Info
        id: version
        run: |
          VERSION=$(node -p "require('./app.json').expo.version")
          VERSION_CODE=$(node -p "require('./app.json').expo.android.versionCode")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬: v$VERSION (Build $VERSION_CODE)"

      - name: Upload APK to TCB Storage
        env:
          API_BASE_URL: https://cloud1-4gee45pq61cd6f19-1259499058.ap-shanghai.app.tcloudbase.com/task-collection-api
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
        run: |
          if [ -f "./test-app-release.apk" ]; then
            echo "å¼€å§‹ä¸Šä¼  APK åˆ°è…¾è®¯äº‘å­˜å‚¨..."
            node scripts/upload-apk-to-tcb.js ./test-app-release.apk
            echo "âœ… ä¸Šä¼ å®Œæˆ"
          else
            echo "âŒ APK æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•ä¸Šä¼ "
            exit 1
          fi

      - name: Upload Test Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-apk
          path: test-app-release.apk
          retention-days: 1

