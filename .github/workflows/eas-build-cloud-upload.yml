name: EAS Build Android Preview (Cloud Upload)

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # ç¡®ä¿æœ‰å†™æƒé™ï¼Œä»¥ä¾¿æ¨é€ç‰ˆæœ¬å·æ›´æ–°

      - name: Setup Node.js (Cache Disabled - Fix 408 Timeout)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # cache: 'npm'  # ä¸´æ—¶ç¦ç”¨ï¼Œé¿å… GitHub ç¼“å­˜æœåŠ¡ 408 é”™è¯¯

      - name: Install dependencies
        run: npm ci  # æ›´å¿«å®‰è£…ï¼Œæ— ç¼“å­˜ä¾èµ–

      - name: Update version for APK build
        id: version
        run: |
          echo "æ›´æ–°ç‰ˆæœ¬å·ï¼ˆAPK æ„å»ºï¼‰..."
          node scripts/update-version.js --type build
          echo "ç‰ˆæœ¬å·æ›´æ–°å®Œæˆ"
          # è¯»å–æ›´æ–°åçš„ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./app.json').expo.version")
          VERSION_CODE=$(node -p "require('./app.json').expo.android.versionCode")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬: v$VERSION (Build $VERSION_CODE)"

      - name: Commit version update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add app.json
          git commit -m "chore: è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å· [skip ci]" || echo "æ²¡æœ‰ç‰ˆæœ¬å˜æ›´æˆ–å·²æ˜¯æœ€æ–°"
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼ˆé€šå¸¸æ˜¯ mainï¼‰
          git push origin HEAD:${{ github.ref_name }} || echo "æ¨é€å¤±è´¥æˆ–æ— éœ€æ¨é€"
          echo "âœ… ç‰ˆæœ¬å·å·²æäº¤åˆ°åˆ†æ”¯: ${{ github.ref_name }}"

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          # expo-cache: false  # ç¦ç”¨ Expo CLI ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

      - name: Run EAS Build with Retry
        env:
          # ä» GitHub Secrets è¯»å– API Key
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
        id: build
        run: |
          # åŠ¨æ€æ›¿æ¢ eas.json ä¸­çš„ ${EXPO_PUBLIC_API_KEY} ä¸ºå®é™…å€¼
          # å› ä¸º EAS Build åœ¨ GitHub Actions ä¸­ä¸ä¼šè‡ªåŠ¨ä» EAS Secrets è¯»å–
          if [ -n "$EXPO_PUBLIC_API_KEY" ]; then
            echo "æ›¿æ¢ eas.json ä¸­çš„ API Key..."
            echo "API Key é•¿åº¦: ${#EXPO_PUBLIC_API_KEY}"
            echo "API Key å‰ç¼€: ${EXPO_PUBLIC_API_KEY:0:8}..."
            
            # ä½¿ç”¨ Node.js è„šæœ¬æ¥å®‰å…¨åœ°æ›¿æ¢ eas.json ä¸­çš„å ä½ç¬¦
            # è¿™æ ·å¯ä»¥æ­£ç¡®å¤„ç† API Key ä¸­çš„ç‰¹æ®Šå­—ç¬¦
            node -e "
              const fs = require('fs');
              const apiKey = process.env.EXPO_PUBLIC_API_KEY;
              const easJson = JSON.parse(fs.readFileSync('eas.json', 'utf8'));
              
              // æ›¿æ¢ preview å’Œ production é…ç½®ä¸­çš„å ä½ç¬¦
              if (easJson.build?.preview?.env?.EXPO_PUBLIC_API_KEY === '\${EXPO_PUBLIC_API_KEY}') {
                easJson.build.preview.env.EXPO_PUBLIC_API_KEY = apiKey;
              }
              if (easJson.build?.production?.env?.EXPO_PUBLIC_API_KEY === '\${EXPO_PUBLIC_API_KEY}') {
                easJson.build.production.env.EXPO_PUBLIC_API_KEY = apiKey;
              }
              
              fs.writeFileSync('eas.json', JSON.stringify(easJson, null, 2));
              console.log('âœ… eas.json å·²æ›´æ–°');
            "
            
            # éªŒè¯æ›¿æ¢æ˜¯å¦æˆåŠŸ
            if grep -q "\"$EXPO_PUBLIC_API_KEY\"" eas.json; then
              echo "âœ… éªŒè¯æˆåŠŸ: eas.json ä¸­çš„ API Key å·²æ­£ç¡®æ›¿æ¢"
            else
              echo "âŒ è­¦å‘Š: eas.json ä¸­çš„ API Key æ›¿æ¢å¯èƒ½å¤±è´¥"
            fi
            
            # åŒæ—¶å°† API Key æ³¨å…¥åˆ° app.json çš„ extra.apiKey å­—æ®µï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
            # ä½¿ç”¨ Node.js è„šæœ¬æ¥å®‰å…¨åœ°ä¿®æ”¹ JSON
            node -e "
              const fs = require('fs');
              const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
              if (!appJson.expo.extra) appJson.expo.extra = {};
              appJson.expo.extra.apiKey = process.env.EXPO_PUBLIC_API_KEY || '';
              fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2));
              console.log('âœ… app.json ä¸­çš„ API Key å·²æ³¨å…¥');
            "
            
            # æ‰“å° app.json çš„ extra éƒ¨åˆ†å†…å®¹
            echo ""
            echo "=== app.json extra éƒ¨åˆ†å†…å®¹ ==="
            node -e "
              const fs = require('fs');
              const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
              console.log(JSON.stringify(appJson.expo.extra, null, 2));
            "
          else
            echo "âš ï¸ è­¦å‘Š: EXPO_PUBLIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®"
          fi
          
          # é‡è¯•é€»è¾‘ï¼šå¦‚æœ 408 è¶…æ—¶ï¼Œè‡ªåŠ¨é‡è·‘
          for i in {1..3}; do
            # é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ API Keyï¼Œç¡®ä¿ EAS Build èƒ½å¤Ÿè¯»å–
            export EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY"
            BUILD_OUTPUT=$(EXPO_PUBLIC_API_KEY="$EXPO_PUBLIC_API_KEY" eas build --platform android --profile preview --non-interactive 2>&1)
            BUILD_EXIT_CODE=$?
            echo "$BUILD_OUTPUT"
            
            if [ $BUILD_EXIT_CODE -eq 0 ]; then
              # æå–ä¸‹è½½ URLï¼ˆä½¿ç”¨æ­£åˆ™åŒ¹é…ï¼Œæ”¯æŒä»»æ„æ–‡ä»¶åï¼‰
              # æ ¼å¼ï¼šhttps://expo.dev/artifacts/eas/<éšæœºå­—ç¬¦ä¸²>.apk
              # æˆ–è€…ï¼šğŸ¤– Android app: https://expo.dev/artifacts/eas/<éšæœºå­—ç¬¦ä¸²>.apk
              DOWNLOAD_URL=$(echo "$BUILD_OUTPUT" | grep -oE 'https://expo\.dev/artifacts/eas/[a-zA-Z0-9]+\.apk' | head -1)
              
              if [ -n "$DOWNLOAD_URL" ]; then
                echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
                echo "âœ… APK ä¸‹è½½åœ°å€: $DOWNLOAD_URL"
              else
                # å¤‡ç”¨æ–¹æ³•1ï¼šåŒ¹é…åŒ…å« "Android app:" çš„è¡Œ
                DOWNLOAD_URL=$(echo "$BUILD_OUTPUT" | grep -i "android app" | grep -oE 'https://expo\.dev/artifacts/eas/[a-zA-Z0-9]+\.apk' | head -1)
                if [ -n "$DOWNLOAD_URL" ]; then
                  echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
                  echo "âœ… APK ä¸‹è½½åœ°å€ï¼ˆå¤‡ç”¨æ–¹æ³•1ï¼‰: $DOWNLOAD_URL"
                else
                  # å¤‡ç”¨æ–¹æ³•2ï¼šä»æ„å»ºè¾“å‡ºä¸­æŸ¥æ‰¾åŒ…å« .apk çš„å®Œæ•´ URL
                  DOWNLOAD_URL=$(echo "$BUILD_OUTPUT" | grep -oE 'https://expo\.dev/[^ ]+\.apk' | head -1)
                  if [ -n "$DOWNLOAD_URL" ]; then
                    echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
                    echo "âœ… APK ä¸‹è½½åœ°å€ï¼ˆå¤‡ç”¨æ–¹æ³•2ï¼‰: $DOWNLOAD_URL"
                  else
                    echo "âš ï¸  è­¦å‘Š: æ— æ³•ä»æ„å»ºè¾“å‡ºä¸­æå– APK ä¸‹è½½åœ°å€"
                    echo "æ„å»ºè¾“å‡ºç‰‡æ®µ:"
                    echo "$BUILD_OUTPUT" | grep -i "android\|apk\|artifact" | head -5
                  fi
                fi
              fi
              break
            fi
            echo "Build $i failed, retrying in 30s..."
            sleep 30
          done

      - name: Display Version Info
        if: success() && steps.build.outputs.download_url != ''
        run: |
          # ç‰ˆæœ¬å·å·²åœ¨æ„å»ºå‰æ›´æ–°ï¼Œè¿™é‡Œåªæ˜¾ç¤º
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_CODE="${{ steps.version.outputs.versionCode }}"
          echo "å½“å‰ç‰ˆæœ¬: v$VERSION (Build $VERSION_CODE)"

      - name: Save Version Info (EAS URL)
        if: success() && steps.build.outputs.download_url != ''
        env:
          API_BASE_URL: https://cloud1-4gee45pq61cd6f19-1259499058.ap-shanghai.app.tcloudbase.com/task-collection-api
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
        run: |
          echo "ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯åˆ°æ•°æ®åº“ï¼ˆEAS URLï¼‰..."
          DOWNLOAD_URL="${{ steps.build.outputs.download_url }}"
          node scripts/save-version-info.js "$DOWNLOAD_URL"
          echo "âœ… ç‰ˆæœ¬ä¿¡æ¯å·²ä¿å­˜ï¼Œå³ä½¿åç»­ä¸Šä¼ å¤±è´¥ï¼Œä¹Ÿå¯ä»¥ä» EAS ä¸‹è½½ APK"

      - name: Cloud Function Download and Upload
        if: success() && steps.build.outputs.download_url != '' && steps.version.outputs.version != ''
        env:
          API_BASE_URL: https://cloud1-4gee45pq61cd6f19-1259499058.ap-shanghai.app.tcloudbase.com/task-collection-api
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
        run: |
          echo "è°ƒç”¨äº‘å‡½æ•°ä¸‹è½½å¹¶ä¸Šä¼  APK..."
          DOWNLOAD_URL="${{ steps.build.outputs.download_url }}"
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_CODE="${{ steps.version.outputs.versionCode }}"
          
          echo "å‚æ•°:"
          echo "  EAS URL: $DOWNLOAD_URL"
          echo "  ç‰ˆæœ¬: v$VERSION (Build $VERSION_CODE)"
          
          # è°ƒç”¨äº‘å‡½æ•°æ¥å£
          node -e "
            const https = require('https');
            const apiKey = process.env.EXPO_PUBLIC_API_KEY;
            const apiBaseUrl = process.env.API_BASE_URL;
            const easUrl = process.argv[2];
            const version = process.argv[3];
            const versionCode = parseInt(process.argv[4], 10);
            
            const requestData = JSON.stringify({
              easDownloadUrl: easUrl,
              version: version,
              versionCode: versionCode,
              platform: 'android'
            });
            
            const url = new URL(apiBaseUrl + '/app/download-and-upload');
            const options = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey,
                'Content-Length': Buffer.byteLength(requestData)
              },
              timeout: 300000  // 5åˆ†é’Ÿè¶…æ—¶ï¼ˆå¤§æ–‡ä»¶ä¸‹è½½å’Œä¸Šä¼ éœ€è¦æ—¶é—´ï¼‰
            };
            
            console.log('å‘é€è¯·æ±‚åˆ°:', url.toString());
            
            const req = https.request(url, options, (res) => {
              let data = '';
              res.on('data', (chunk) => { data += chunk; });
              res.on('end', () => {
                try {
                  const result = JSON.parse(data);
                  if (res.statusCode === 200 && result.code === 0) {
                    console.log('âœ… äº‘å‡½æ•°ä¸‹è½½å¹¶ä¸Šä¼ æˆåŠŸ');
                    console.log('æ–‡ä»¶è·¯å¾„:', result.data.filePath);
                    console.log('æ–‡ä»¶ URL:', result.data.fileUrl);
                    console.log('æ–‡ä»¶å¤§å°:', (result.data.fileSize / 1024 / 1024).toFixed(2), 'MB');
                    process.exit(0);
                  } else {
                    console.error('âŒ äº‘å‡½æ•°è¿”å›é”™è¯¯:', result.message || 'æœªçŸ¥é”™è¯¯');
                    console.error('å“åº”:', JSON.stringify(result, null, 2));
                    process.exit(1);
                  }
                } catch (e) {
                  console.error('âŒ è§£æå“åº”å¤±è´¥:', e.message);
                  console.error('åŸå§‹å“åº”:', data);
                  process.exit(1);
                }
              });
            });
            
            req.on('error', (error) => {
              console.error('âŒ è¯·æ±‚å¤±è´¥:', error.message);
              process.exit(1);
            });
            
            req.on('timeout', () => {
              req.destroy();
              console.error('âŒ è¯·æ±‚è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰');
              process.exit(1);
            });
            
            req.write(requestData);
            req.end();
          " "$DOWNLOAD_URL" "$VERSION" "$VERSION_CODE"
          echo "âœ… APK ä¸Šä¼ æˆåŠŸï¼Œç‰ˆæœ¬å·å·²è‡ªåŠ¨æ›´æ–°å¹¶æäº¤åˆ° Git"
      
      - name: Verify Version Update
        if: success() && steps.build.outputs.download_url != '' && steps.version.outputs.version != ''
        run: |
          echo "éªŒè¯ç‰ˆæœ¬å·æ›´æ–°..."
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_CODE="${{ steps.version.outputs.versionCode }}"
          CURRENT_VERSION=$(node -p "require('./app.json').expo.version")
          CURRENT_VERSION_CODE=$(node -p "require('./app.json').expo.android.versionCode")
          
          if [ "$CURRENT_VERSION" = "$VERSION" ] && [ "$CURRENT_VERSION_CODE" = "$VERSION_CODE" ]; then
            echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: v$CURRENT_VERSION (Build $CURRENT_VERSION_CODE)"
          else
            echo "âš ï¸  è­¦å‘Š: ç‰ˆæœ¬å·ä¸ä¸€è‡´"
            echo "  æœŸæœ›: v$VERSION (Build $VERSION_CODE)"
            echo "  å®é™…: v$CURRENT_VERSION (Build $CURRENT_VERSION_CODE)"
          fi

      - name: Upload Build Artifact (If Success)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-app-cloud-upload
          path: |
            *.aab
            *.apk
          retention-days: 7
          if-no-files-found: ignore

