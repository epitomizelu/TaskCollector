name: EAS Update (OTA)

on:
  workflow_dispatch:  # 仅手动触发
    inputs:
      branch:
        description: '更新分支（如 production, preview）'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
      message:
        description: '更新说明'
        required: true
        default: 'OTA 更新'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # 确保有写权限，以便推送版本号更新

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get current version
        id: version
        run: |
          # OTA 更新时不改变 version，因为 runtimeVersion 使用 appVersion 策略
          # 如果 version 改变，已安装的应用将无法接收 OTA 更新
          VERSION=$(node -p "require('./app.json').expo.version")
          VERSION_CODE=$(node -p "require('./app.json').expo.android.versionCode")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "当前版本: v$VERSION (Build $VERSION_CODE)"
          echo "⚠️ 注意: OTA 更新不会改变 version，以保持 runtimeVersion 一致"

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Determine update branch and message
        id: update-info
        run: |
          # 手动触发：使用输入参数
          echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
          echo "message=${{ github.event.inputs.message }}" >> $GITHUB_OUTPUT

      - name: Run EAS Update
        run: |
          BRANCH="${{ steps.update-info.outputs.branch }}"
          MESSAGE="${{ steps.update-info.outputs.message }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "发布 OTA 更新到分支: $BRANCH"
          echo "更新说明: $MESSAGE"
          echo "新版本号: v$VERSION"
          
          # 在更新说明中包含版本号
          FULL_MESSAGE="v$VERSION - $MESSAGE"
          
          eas update --branch "$BRANCH" --message "$FULL_MESSAGE" --non-interactive

      - name: Save OTA version info to database
        if: success()
        env:
          API_BASE_URL: https://cloud1-4gee45pq61cd6f19-1259499058.ap-shanghai.app.tcloudbase.com/task-collection-api
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
        run: |
          echo "保存 OTA 更新版本信息到数据库..."
          VERSION="${{ steps.version.outputs.version }}"
          MESSAGE="${{ steps.update-info.outputs.message }}"
          node scripts/save-ota-version.js "$MESSAGE"
          echo "✅ OTA 更新版本信息已保存"

      - name: List updates
        run: |
          BRANCH="${{ steps.update-info.outputs.branch }}"
          echo "查看分支 $BRANCH 的更新列表:"
          eas update:list --branch "$BRANCH" --non-interactive || echo "分支 $BRANCH 可能还没有更新"

