name: Test API Key Injection

on:
  workflow_dispatch:  # 仅手动触发

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Backup original files
        run: |
          cp eas.json eas.json.backup
          cp app.json app.json.backup

      - name: Test API Key Injection Code
        env:
          EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}
        run: |
          if [ -n "$EXPO_PUBLIC_API_KEY" ]; then
            echo "替换 eas.json 中的 API Key..."
            echo "API Key 长度: ${#EXPO_PUBLIC_API_KEY}"
            echo "API Key 前缀: ${EXPO_PUBLIC_API_KEY:0:8}..."
            
            # 使用 Node.js 脚本来安全地替换 eas.json 中的占位符
            # 这样可以正确处理 API Key 中的特殊字符
            node -e "
              const fs = require('fs');
              const apiKey = process.env.EXPO_PUBLIC_API_KEY;
              const easJson = JSON.parse(fs.readFileSync('eas.json', 'utf8'));
              
              // 替换 preview 和 production 配置中的占位符
              if (easJson.build?.preview?.env?.EXPO_PUBLIC_API_KEY === '\${EXPO_PUBLIC_API_KEY}') {
                easJson.build.preview.env.EXPO_PUBLIC_API_KEY = apiKey;
              }
              if (easJson.build?.production?.env?.EXPO_PUBLIC_API_KEY === '\${EXPO_PUBLIC_API_KEY}') {
                easJson.build.production.env.EXPO_PUBLIC_API_KEY = apiKey;
              }
              
              fs.writeFileSync('eas.json', JSON.stringify(easJson, null, 2));
              console.log('✅ eas.json 已更新');
            "
            
            # 验证替换是否成功
            if grep -q "\"$EXPO_PUBLIC_API_KEY\"" eas.json; then
              echo "✅ 验证成功: eas.json 中的 API Key 已正确替换"
            else
              echo "❌ 警告: eas.json 中的 API Key 替换可能失败"
            fi
            
            # 打印注入后的 eas.json 内容
            echo ""
            echo "=== 注入后的 eas.json 内容 ==="
            cat eas.json
            
            # 同时将 API Key 注入到 app.json 的 extra.apiKey 字段（作为备用方案）
            # 使用 Node.js 脚本来安全地修改 JSON
            node -e "
              const fs = require('fs');
              const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
              if (!appJson.expo.extra) appJson.expo.extra = {};
              appJson.expo.extra.apiKey = process.env.EXPO_PUBLIC_API_KEY || '';
              fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2));
              console.log('✅ app.json 中的 API Key 已注入');
            "
            
            # 打印 app.json 的 extra 部分内容
            echo ""
            echo "=== app.json extra 部分内容 ==="
            node -e "
              const fs = require('fs');
              const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
              console.log(JSON.stringify(appJson.expo.extra, null, 2));
            "
          else
            echo "⚠️ 警告: EXPO_PUBLIC_API_KEY 环境变量未设置"
          fi

      - name: Show results
        run: |
          echo "=== eas.json 内容 ==="
          cat eas.json
          echo ""
          echo "=== app.json extra 部分 ==="
          node -e "const fs = require('fs'); const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8')); console.log(JSON.stringify(appJson.expo.extra, null, 2));"

      - name: Restore original files
        if: always()
        run: |
          mv eas.json.backup eas.json
          mv app.json.backup app.json
          echo "✅ 已恢复原文件"

